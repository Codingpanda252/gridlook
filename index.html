<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>gridlook - ICON native grid viewer</title>
		<style>
			body { margin: 0; }
		</style>
	</head>
	<body>
    </body>
    <script src="js/three.js"></script>
    <script src="js/js-colormaps.js"></script>
    <script src="js/world_controls.js"></script>
    <script src="js/gridlook.js"></script>
    <script  type="module">
        import { HTTPStore, openArray, openGroup } from "https://cdn.skypack.dev/zarr";
        const store = new HTTPStore("https://swift.dkrz.de/v1/dkrz_948e7d4bbfbb445fbff5315fc433e36a/nextGEMS/");

        const scene = new THREE.Scene();
        const center = new THREE.Vector3();
        const camera = new THREE.PerspectiveCamera( 7.5, window.innerWidth / window.innerHeight, 0.1, 1000 );

        const renderer = new THREE.WebGLRenderer();
        renderer.setSize( window.innerWidth, window.innerHeight );
        document.body.appendChild( renderer.domElement );

        // const geometry = new THREE.BoxGeometry();
        // const material = new THREE.MeshBasicMaterial( { color: 0x00ff00 } );
        // const cube = new THREE.Mesh( geometry, material );
        // scene.add( cube );

        camera.up = new THREE.Vector3(0, 0, 1);
        camera.position.x = 30;
        camera.lookAt(center);

        async function fetchGrid(grid, plotdata, colormap) {
            const [verts, color] = await Promise.all([
                grid2buffer(grid),
                data2color_buffer(plotdata, colormap)
            ]);

            console.log("verts have nan: " + verts.some(isNaN));

            const geometry = new THREE.BufferGeometry();
            geometry.setAttribute( 'position', new THREE.BufferAttribute( verts, 3 ) );
            geometry.setAttribute( 'color', new THREE.BufferAttribute( color, 3 ) );

            const material = new THREE.MeshBasicMaterial( { side: THREE.DoubleSide, vertexColors: THREE.VertexColors } );
            const mesh = new THREE.Mesh( geometry, material );
            scene.add(mesh);

            redraw();
        }

        console.log(cm_data);
        async function getData() {
            console.log("fetching");
            const grid = await openGroup(store, "grids/ICON_R02B06.zarr", "r");
            const data = await openGroup(store, "nextGEMS_ICON_3d_prw_R02B06.zarr", "r");
            const prw = data.getItem("prw").then(d => d.get(1))
            await fetchGrid(grid, prw, "turbo_r");
            console.log("done");
        }
    
        getData();


        function render() {
            renderer.render(scene, camera);
        }

        var frameId = 0;
        function redraw() {
            cancelAnimationFrame(frameId);
            frameId = requestAnimationFrame(render);
        }

        attachControls(renderer, camera, center, redraw);

        function onWindowResize() {

            const aspect = window.innerWidth / window.innerHeight;

            camera.aspect = aspect;
            camera.updateProjectionMatrix();

            //cameraOrtho.left = cameraOrtho.bottom * aspect;
            //cameraOrtho.right = cameraOrtho.top * aspect;
            //cameraOrtho.updateProjectionMatrix();

            renderer.setSize( window.innerWidth, window.innerHeight );

            render();

        }

        redraw();
        window.addEventListener( 'resize', onWindowResize );

    </script>
</html>
